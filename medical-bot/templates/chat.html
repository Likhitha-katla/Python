 <!-- <!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>HexaNova Chatbot</title>
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <style>
        body { background: linear-gradient(135deg, #1d2630, #2b2336); color: #e9eef6; }
        .chat { padding: 24px 0; min-height: 100vh; }
        .card { background: #121419; border-radius: 16px; border: none; box-shadow: 0 6px 24px rgba(0,0,0,0.6); }
        .msg_card_body { height: 480px; overflow-y: auto; padding: 24px; }
        .msg_container { background: #1e2933; color: #e6f0ff; padding: 14px; border-radius: 14px; max-width: 75%; }
        .msg_container_send { background: #34c77d; color: #07211a; padding: 14px; border-radius: 14px; max-width: 75%; }
        .msg_time, .msg_time_send { display:block; font-size: 11px; margin-top: 6px; opacity: 0.8; }
        .img_cont_msg img { width: 40px; height: 40px; border-radius: 50%; }
        .user_img { width: 60px; height: 60px; border-radius: 50%; }
        .input-group { background: transparent; }
        .type_msg { background: #0f1113; border: none; color: #e9eef6; }
        .send_btn { background: #0f1113; color: #fff; border: none; cursor: pointer; }
        .recording { background-color: #ff4d4d !important; color: white !important; }
    </style>
</head>
<body>
<div class="container-fluid h-100">
    <div class="row justify-content-center h-100">
        <div class="col-md-8 col-xl-6 chat">
            <div class="card">
                <div class="card-header msg_head">
                    <div class="d-flex bd-highlight">
                        <div class="img_cont">
                            <img src="https://media.licdn.com/dms/image/v2/D560BAQHuNloUjLJ4RQ/company-logo_200_200/company-logo_200_200/0/1709498349714?e=2147483647&v=beta&t=nXQxY0NMFsSKf2wXaWW6aQvNldxqQgAAXCIoBYOmKTY" class="user_img">
                            <span class="online_icon" style="position: relative; left:-18px; top:38px; width:12px;height:12px;background:#4ade80;border-radius:50%;display:inline-block;border:2px solid #111;"></span>
                        </div>
                        <div class="user_info" style="margin-left:12px;">
                            <span style="font-weight:600; font-size:1.2rem;">HexaNova Chatbot</span>
                            <p style="margin:0;opacity:0.8;">Ask me about my company!</p>
                        </div>
                    </div>
                </div>

                <div id="messageFormeight" class="card-body msg_card_body"></div>

                <div class="card-footer">
                    <form id="messageArea" class="input-group">
                        <input type="text" id="text" name="msg" placeholder="Type your message..." autocomplete="off" class="form-control type_msg"/>
                        <div class="input-group-append">
                            <button type="submit" id="send" class="input-group-text send_btn"><i class="fas fa-location-arrow"></i></button>
                            <button type="button" id="micBtn" class="input-group-text send_btn"><i class="fas fa-microphone"></i></button>
                            <button type="button" id="muteBtn" class="input-group-text send_btn"><i class="fas fa-volume-up"></i></button>
                        </div>
                    </form>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    let isMuted = false;

    function appendMessage(sender, text, time) {
        let html;
        if (sender === "user") {
            html = `
                <div class="d-flex justify-content-end mb-4">
                    <div class="msg_container_send">${text}<span class="msg_time_send">${time}</span></div>
                    <div class="img_cont_msg" style="margin-left:10px;">
                        <img src="https://i.ibb.co/d5b84Xw/Untitled-design.png" class="rounded-circle user_img_msg">
                    </div>
                </div>`;
        } else {
            html = `
                <div class="d-flex justify-content-start mb-4">
                    <div class="img_cont_msg" style="margin-right:10px;">
                        <img src="https://media.licdn.com/dms/image/v2/D560BAQHuNloUjLJ4RQ/company-logo_200_200/company-logo_200_200/0/1709498349714?e=2147483647&v=beta&t=nXQxY0NMFsSKf2wXaWW6aQvNldxqQgAAXCIoBYOmKTY" class="rounded-circle user_img_msg">
                    </div>
                    <div class="msg_container">${text}<span class="msg_time">${time}</span></div>
                </div>`;
        }
        $("#messageFormeight").append($.parseHTML(html));
        $("#messageFormeight").scrollTop($("#messageFormeight")[0].scrollHeight);
    }

    // Text submit
    $("#messageArea").on("submit", function(event) {
        event.preventDefault();
        const date = new Date();
        const str_time = date.getHours() + ":" + String(date.getMinutes()).padStart(2, '0');
        var rawText = $("#text").val();
        if (!rawText.trim()) return;

        appendMessage("user", rawText, str_time);
        $("#text").val("");

        $.ajax({
            data: { msg: rawText },
            type: "POST",
            url: "/get"
        }).done(function(data) {
            appendMessage("bot", data.answer || "No answer", str_time);
            if ('speechSynthesis' in window && data.answer && !isMuted) {
                const u = new SpeechSynthesisUtterance(data.answer);
                speechSynthesis.speak(u);
            }
        }).fail(function(err) {
            appendMessage("bot", "Server error. See console.", str_time);
            console.error(err);
        });
    });

    // Voice recording
    let mediaRecorder;
    let audioChunks = [];
    $("#micBtn").on("click", function() {
        navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.start();
            $("#micBtn").addClass("recording");

            mediaRecorder.addEventListener("dataavailable", event => {
                audioChunks.push(event.data);
            });

            mediaRecorder.addEventListener("stop", () => {
                $("#micBtn").removeClass("recording");
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const formData = new FormData();
                formData.append("audio", audioBlob, "voice.webm");

                fetch("/voice", { method: "POST", body: formData })
                    .then(res => res.json())
                    .then(data => {
                        if (data.question) {
                            // Put recognized text into input box (editable)
                            $("#text").val(data.question);
                            $("#text").focus();
                        }
                        // Do not auto-send. User decides to edit and press send.
                    }).catch(err => {
                        console.error(err);
                        appendMessage("bot", "Voice handling error.", new Date().getHours() + ":" + String(new Date().getMinutes()).padStart(2,'0'));
                    });
            });

            setTimeout(() => mediaRecorder.stop(), 4000);
        }).catch(err => {
            console.error("getUserMedia error:", err);
            alert("Microphone access denied or not available.");
        });
    });

    // Mute toggle
    $("#muteBtn").on("click", function() {
        isMuted = !isMuted;
        if (isMuted) {
            $(this).find("i").removeClass("fa-volume-up").addClass("fa-volume-mute");
            speechSynthesis.cancel();
        } else {
            $(this).find("i").removeClass("fa-volume-mute").addClass("fa-volume-up");
        }
    });
});
</script>
</body>
</html> -->


<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>HexaNova Chatbot</title>
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <style>
        body { background: linear-gradient(135deg, #1d2630, #2b2336); color: #e9eef6; }
        .chat { padding: 24px 0; min-height: 100vh; }
        .card { background: #121419; border-radius: 16px; border: none; box-shadow: 0 6px 24px rgba(0,0,0,0.6); }
        .msg_card_body { height: 480px; overflow-y: auto; padding: 24px; }
        .msg_container { background: #1e2933; color: #e6f0ff; padding: 14px; border-radius: 14px; max-width: 75%; }
        .msg_container_send { background: #34c77d; color: #07211a; padding: 14px; border-radius: 14px; max-width: 75%; }
        .msg_time, .msg_time_send { display:block; font-size: 11px; margin-top: 6px; opacity: 0.8; }
        .img_cont_msg img { width: 40px; height: 40px; border-radius: 50%; }
        .user_img { width: 60px; height: 60px; border-radius: 50%; }
        .input-group { background: transparent; }
        .type_msg { background: #0f1113; border: none; color: #e9eef6; }
        .send_btn { background: #0f1113; color: #fff; border: none; cursor: pointer; }
        .recording { background-color: #ff4d4d !important; color: white !important; }
    </style>
</head>
<body>
<div class="container-fluid h-100">
    <div class="row justify-content-center h-100">
        <div class="col-md-8 col-xl-6 chat">
            <div class="card">
                <div class="card-header msg_head">
                    <div class="d-flex bd-highlight">
                        <div class="img_cont">
                            <img src="https://media.licdn.com/dms/image/v2/D560BAQHuNloUjLJ4RQ/company-logo_200_200/company-logo_200_200/0/1709498349714?e=2147483647&v=beta&t=nXQxY0NMFsSKf2wXaWW6aQvNldxqQgAAXCIoBYOmKTY" class="user_img">
                            <span class="online_icon" style="position: relative; left:-18px; top:38px; width:12px;height:12px;background:#4ade80;border-radius:50%;display:inline-block;border:2px solid #111;"></span>
                        </div>
                        <div class="user_info" style="margin-left:12px;">
                            <span style="font-weight:600; font-size:1.2rem;">HexaNova Chatbot</span>
                            <p style="margin:0;opacity:0.8;">Ask me about my company!</p>
                        </div>
                    </div>
                </div>

                <div id="messageFormeight" class="card-body msg_card_body"></div>

                <div class="card-footer">
                    <form id="messageArea" class="input-group">
                        <input type="text" id="text" name="msg" placeholder="Type your message..." autocomplete="off" class="form-control type_msg"/>
                        <div class="input-group-append">
                            <button type="submit" id="send" class="input-group-text send_btn"><i class="fas fa-location-arrow"></i></button>
                            <button type="button" id="micBtn" class="input-group-text send_btn"><i class="fas fa-microphone"></i></button>
                            <button type="button" id="muteBtn" class="input-group-text send_btn"><i class="fas fa-volume-up"></i></button>
                        </div>
                    </form>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    let isMuted = false;
    let lastBotMessage = "";

    function appendMessage(sender, text, time) {
        let html;
        if (sender === "user") {
            html = `
                <div class="d-flex justify-content-end mb-4">
                    <div class="msg_container_send">${text}<span class="msg_time_send">${time}</span></div>
                    <div class="img_cont_msg" style="margin-left:10px;">
                        <img src="https://i.ibb.co/d5b84Xw/Untitled-design.png" class="rounded-circle user_img_msg">
                    </div>
                </div>`;
        } else {
            html = `
                <div class="d-flex justify-content-start mb-4">
                    <div class="img_cont_msg" style="margin-right:10px;">
                        <img src="https://media.licdn.com/dms/image/v2/D560BAQHuNloUjLJ4RQ/company-logo_200_200/company-logo_200_200/0/1709498349714?e=2147483647&v=beta&t=nXQxY0NMFsSKf2wXaWW6aQvNldxqQgAAXCIoBYOmKTY" class="rounded-circle user_img_msg">
                    </div>
                    <div class="msg_container">${text}<span class="msg_time">${time}</span></div>
                </div>`;
        }
        $("#messageFormeight").append($.parseHTML(html));
        $("#messageFormeight").scrollTop($("#messageFormeight")[0].scrollHeight);
    }

    // Text submit
    $("#messageArea").on("submit", function(event) {
        event.preventDefault();
        const date = new Date();
        const str_time = date.getHours() + ":" + String(date.getMinutes()).padStart(2, '0');
        var rawText = $("#text").val();
        if (!rawText.trim()) return;

        appendMessage("user", rawText, str_time);
        $("#text").val("");

        $.ajax({
            data: { msg: rawText },
            type: "POST",
            url: "/get"
        }).done(function(data) {
            const botMsg = data.answer || "No answer";
            appendMessage("bot", botMsg, str_time);
            lastBotMessage = botMsg;

            if ('speechSynthesis' in window && botMsg && !isMuted) {
                const u = new SpeechSynthesisUtterance(botMsg);
                speechSynthesis.speak(u);
            }
        }).fail(function(err) {
            appendMessage("bot", "Server error. See console.", str_time);
            console.error(err);
        });
    });

    // Voice recording
    let mediaRecorder;
    let audioChunks = [];
    $("#micBtn").on("click", function() {
        navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.start();
            $("#micBtn").addClass("recording");

            mediaRecorder.addEventListener("dataavailable", event => {
                audioChunks.push(event.data);
            });

            mediaRecorder.addEventListener("stop", () => {
                $("#micBtn").removeClass("recording");
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const formData = new FormData();
                formData.append("audio", audioBlob, "voice.webm");

                fetch("/voice", { method: "POST", body: formData })
                    .then(res => res.json())
                    .then(data => {
                        if (data.question) {
                            // Put recognized text into input box (editable)
                            $("#text").val(data.question);
                            $("#text").focus();
                        }
                        // User can edit and press send
                    }).catch(err => {
                        console.error(err);
                        appendMessage("bot", "Voice handling error.", new Date().getHours() + ":" + String(new Date().getMinutes()).padStart(2,'0'));
                    });
            });

            setTimeout(() => mediaRecorder.stop(), 4000);
        }).catch(err => {
            console.error("getUserMedia error:", err);
            alert("Microphone access denied or not available.");
        });
    });

    // Mute toggle
    $("#muteBtn").on("click", function() {
        isMuted = !isMuted;
        if (isMuted) {
            $(this).find("i").removeClass("fa-volume-up").addClass("fa-volume-mute");
            speechSynthesis.cancel();
        } else {
            $(this).find("i").removeClass("fa-volume-mute").addClass("fa-volume-up");
            // Replay last bot message when unmuted
            if (lastBotMessage) {
                const u = new SpeechSynthesisUtterance(lastBotMessage);
                speechSynthesis.speak(u);
            }
        }
    });
});
</script>
</body>
</html>
